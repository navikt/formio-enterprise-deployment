name: Deploy Formio enterprise server
run-name: Manual deploy of ${{ github.event.inputs.environment }} (${{ github.head_ref || github.ref_name }}) with version ${{ github.event.inputs.imageVersion }}

on:
  workflow_dispatch:
    inputs:
      imageVersion:
        description: "Version of the image"
        required: true
        type: string
      environment:
        description: "To which environment?"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - authoring
          - production
env:
  IMAGE: ghcr.io/${{ github.repository }}/formio-enterprise-nav:${{ inputs.imageVersion }}

concurrency: deploy-${{ github.ref }}

jobs:
  deploy-to-dev:
    name: "Deploy Formio dev api server"
    if: ${{ inputs.environment == 'development' }}
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2"
      - uses: actions/setup-node@v3
        with:
          node-version: "16.17.1"
      - name: "Deploy dev instance"
        env:
          APIKEY: "${{ secrets.NAIS_DEPLOY_APIKEY }}"
          CLUSTER: "dev-gcp"
          RESOURCE: ".nais/nais.yaml"
          VARS: ".nais/dev.yaml"
        uses: "nais/deploy/actions/deploy@v1"

  deploy-to-authoring:
    name: "Deploy Formio authoring api server"
    if: ${{ inputs.environment == 'authoring' }}
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2"
      - uses: actions/setup-node@v3
        with:
          node-version: "16.17.1"
      - name: "Deploy authoring instance"
        env:
          APIKEY: "${{ secrets.NAIS_DEPLOY_APIKEY }}"
          CLUSTER: "dev-gcp"
          RESOURCE: ".nais/nais.yaml"
          VARS: ".nais/authoring.yaml"
        uses: "nais/deploy/actions/deploy@v1"

  deploy-to-prod:
    name: "Deploy Formio production api server"
    if: ${{ inputs.environment == 'production' }}
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2"
      - uses: actions/setup-node@v3
        with:
          node-version: "16.17.1"
      - name: "Deploy prod instance"
        env:
          APIKEY: "${{ secrets.NAIS_DEPLOY_APIKEY }}"
          CLUSTER: "prod-gcp"
          RESOURCE: ".nais/nais.yaml"
          VARS: ".nais/prod.yaml"
        uses: "nais/deploy/actions/deploy@v1"
